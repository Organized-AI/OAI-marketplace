# Walk Session: Export to Claude Code

> **Branch:** `feature/export-claude-code`
> **Total Duration:** 1.5-2 hours (1 Claude Code Web session)
> **Phases:** 4
> **Token Budget:** ~120-150 Claude Code prompts
> **Prerequisites:** Builder canvas with components, jszip available

---

## Session Budget Allocation

| Phase | Focus | Token Budget | Time |
|-------|-------|--------------|------|
| Phase 1 | Export Generator | 30% (~40 prompts) | 35 min |
| Phase 2 | API Endpoint | 20% (~25 prompts) | 20 min |
| Phase 3 | UI Components | 35% (~45 prompts) | 35 min |
| Phase 4 | Integration | 15% (~20 prompts) | 15 min |

---

## Pre-Flight Checklist

```markdown
Before starting, verify:
- [ ] Builder canvas has working components
- [ ] Components have metadata (name, type, config, prompt)
- [ ] Can npm install new packages
- [ ] No TypeScript errors in builder code
```

---

## Phase 1: Export Generator (40 prompts, 35 min)

### Prompt 1.1: Create Export Generator Types
```
Create `lib/export-generator.ts` with type definitions:

1. StackComponent interface:
   - id: string
   - type: 'agent' | 'mcp' | 'hook' | 'command' | 'setting'
   - name: string
   - config?: Record<string, any>
   - prompt?: string
   - description?: string

2. ExportFile interface:
   - path: string
   - content: string

3. ExportResult interface:
   - files: ExportFile[]
   - installCommands: string[]
   - mcpConfigs: Record<string, any>

4. Export the interfaces for use elsewhere
```

**FILES_CREATED:**
- `lib/export-generator.ts`

### Prompt 1.2: Implement Main Export Function
```
Add the main generateExport function to lib/export-generator.ts:

1. Function signature:
   generateExport(components: StackComponent[], projectName: string): ExportResult

2. Separate components by type:
   - agents = filter type === 'agent'
   - mcps = filter type === 'mcp'
   - hooks = filter type === 'hook'
   - commands = filter type === 'command'
   - settings = filter type === 'setting'

3. Initialize:
   - files: ExportFile[] = []
   - installCommands: string[] = []
   - mcpConfigs: Record<string, any> = {}

4. Generate each file type (implement in next prompts):
   - CLAUDE.md
   - settings.json
   - commands/*.md
   - mcp.json (if MCPs exist)

5. Return { files, installCommands, mcpConfigs }
```

**FILES_MODIFIED:**
- `lib/export-generator.ts`

### Prompt 1.3: Implement CLAUDE.md Generator
```
Add generateClaudeMd function to lib/export-generator.ts:

1. Function: generateClaudeMd(projectName, agents, mcps): string

2. Build markdown content:
   # {projectName}
   
   ## Project Overview
   This project uses Claude Code with the following configuration.

3. If agents exist, add:
   ## Agents
   
   ### {agent.name}
   {agent.description || 'No description provided.'}
   
   {agent.prompt || ''}

4. If mcps exist, add:
   ## Available Tools (MCPs)
   
   - **{mcp.name}**: {mcp.description}

5. Add usage section:
   ## Usage
   
   This configuration was generated by [Organized AI Stack Builder](https://stack.organizedai.vip).
   
   To use this configuration:
   1. Copy the `.claude/` directory to your project root
   2. Run any MCP install commands if needed
   3. Start Claude Code in this directory

6. Return the markdown string
```

**FILES_MODIFIED:**
- `lib/export-generator.ts`

### Prompt 1.4: Implement settings.json Generator
```
Add generateSettingsJson function to lib/export-generator.ts:

1. Function: generateSettingsJson(settings, hooks): Record<string, any>

2. Start with base config:
   {
     version: '1.0',
     generatedBy: 'Organized AI Stack Builder',
     generatedAt: new Date().toISOString()
   }

3. Apply settings:
   - For each setting, merge setting.config into config

4. Apply hooks:
   - If hooks exist, add config.hooks = {}
   - For each hook with hookType and script:
     config.hooks[hook.config.hookType] = hook.config.script

5. Return the config object (caller will JSON.stringify)
```

**FILES_MODIFIED:**
- `lib/export-generator.ts`

### Prompt 1.5: Implement Command File Generator
```
Add generateCommandFile function to lib/export-generator.ts:

1. Function: generateCommandFile(command: StackComponent): string

2. Build markdown:
   # {command.name}
   
   {command.description || ''}
   
   {command.prompt || '## Instructions\n\nExecute the {command.name} workflow.'}

3. Return the markdown string

4. In main generateExport, loop through commands:
   commands.forEach(cmd => {
     files.push({
       path: `.claude/commands/${cmd.id}.md`,
       content: generateCommandFile(cmd)
     });
   });
```

**FILES_MODIFIED:**
- `lib/export-generator.ts`

### Prompt 1.6: Implement MCP Config and Zip
```
Complete lib/export-generator.ts:

1. In main generateExport, handle MCPs:
   mcps.forEach(mcp => {
     if (mcp.config?.installCommand) {
       installCommands.push(mcp.config.installCommand);
     }
     if (mcp.config?.mcpConfig) {
       mcpConfigs[mcp.id] = mcp.config.mcpConfig;
     }
   });

2. If mcpConfigs not empty, add mcp.json:
   files.push({
     path: '.claude/mcp.json',
     content: JSON.stringify({ mcpServers: mcpConfigs }, null, 2)
   });

3. Add generateZip async function:
   export async function generateZip(files: ExportFile[]): Promise<Blob> {
     const JSZip = (await import('jszip')).default;
     const zip = new JSZip();
     
     files.forEach(file => {
       zip.file(file.path, file.content);
     });
     
     return await zip.generateAsync({ type: 'blob' });
   }
```

**FILES_MODIFIED:**
- `lib/export-generator.ts`

### Quality Gate 1
```markdown
âœ… Phase 1 Complete when:
- [ ] generateExport returns correct ExportResult
- [ ] CLAUDE.md content is well-formatted
- [ ] settings.json includes all settings and hooks
- [ ] Command files generate correctly
- [ ] MCP configs extracted properly
- [ ] generateZip compiles (test in Phase 2)

Report: "âœ… Phase 1 Complete: Export generator ready"
```

---

## Phase 2: API Endpoint (25 prompts, 20 min)

### Prompt 2.1: Install jszip Dependency
```
Install jszip for ZIP generation:

npm install jszip
npm install --save-dev @types/jszip (if needed)

Verify no errors in package.json or lock file.
```

### Prompt 2.2: Create Export API Route
```
Create `app/api/export/route.ts`:

1. Import generateExport, generateZip from lib/export-generator

2. POST handler accepts JSON:
   - components: StackComponent[]
   - projectName: string
   - format?: 'json' | 'zip'

3. Validate components array exists and not empty

4. Call generateExport(components, projectName || 'My Stack')

5. If format === 'zip':
   - Call generateZip(exportResult.files)
   - Convert blob to arrayBuffer
   - Return NextResponse with arrayBuffer
   - Set headers: Content-Type: application/zip
   - Set Content-Disposition: attachment; filename="{projectName}.zip"

6. Otherwise return JSON:
   {
     files: exportResult.files,
     installCommands: exportResult.installCommands,
     summary: {
       fileCount: files.length,
       hasCommands: boolean,
       hasMcpConfig: boolean
     }
   }

7. Handle errors with 500 status
```

**FILES_CREATED:**
- `app/api/export/route.ts`

### Prompt 2.3: Test Export API
```
Test the export API:

1. POST /api/export with sample components:
   {
     "components": [
       {"id": "test-agent", "type": "agent", "name": "Test Agent", "prompt": "You are a test agent."}
     ],
     "projectName": "test-project"
   }

2. Verify JSON response has correct files

3. Test with format=zip, verify download works

4. Test with empty components - should return 400

5. Test with multiple component types

Fix any issues.
```

### Quality Gate 2
```markdown
âœ… Phase 2 Complete when:
- [ ] JSON preview returns correct file structure
- [ ] ZIP download works
- [ ] CLAUDE.md content is correct in response
- [ ] settings.json formatted properly
- [ ] Error handling works for edge cases

Report: "âœ… Phase 2 Complete: Export API ready"
```

---

## Phase 3: UI Components (45 prompts, 35 min)

### Prompt 3.1: Create Export Modal Structure
```
Create `components/stack-builder/ExportModal.tsx`:

1. Props:
   - isOpen: boolean
   - onClose: () => void
   - components: any[]
   - projectName?: string (default 'my-stack')

2. State:
   - files: ExportFile[]
   - installCommands: string[]
   - isLoading: boolean
   - activeFile: string | null (path of selected file)
   - copied: string | null (tracks what was copied)

3. ExportFile interface (local or imported):
   - path: string
   - content: string

4. useEffect: when isOpen and components.length > 0, call generatePreview()

5. generatePreview async function:
   - Set isLoading true
   - POST to /api/export with components and projectName
   - Set files and installCommands from response
   - Set activeFile to first file path
   - Set isLoading false

6. Return null if !isOpen
```

**FILES_CREATED:**
- `components/stack-builder/ExportModal.tsx`

### Prompt 3.2: Build Export Modal Layout
```
Complete the ExportModal UI:

1. Overlay: fixed inset-0, black/50 backdrop

2. Modal container: white bg, max-w-4xl, max-h-[85vh], overflow-hidden

3. Header:
   - Title: "Export to Claude Code"
   - Subtitle: "{components.length} components â†’ {files.length} files"
   - Close button (âœ•)

4. Loading state: centered "Generating export..."

5. Main content when loaded:
   - Two-column layout (file tree + content)
   - Install commands section (if any)
   - Action buttons at bottom
```

**FILES_MODIFIED:**
- `components/stack-builder/ExportModal.tsx`

### Prompt 3.3: Build File Tree Panel
```
Add file tree to ExportModal:

1. Left panel: w-48, border-r, padding

2. Header: "FILES" label

3. File buttons:
   - Map over files
   - Button for each with file.path.split('/').pop() (filename only)
   - onClick sets activeFile to file.path
   - Active state: blue background
   - Truncate long names

4. Scrollable if many files
```

**FILES_MODIFIED:**
- `components/stack-builder/ExportModal.tsx`

### Prompt 3.4: Build File Content Panel
```
Add file content viewer to ExportModal:

1. Right panel: flex-1, flex flex-col

2. Header bar:
   - Show full path in <code>
   - Copy button for current file content
   - Show "âœ“ Copied!" briefly after copy

3. Content area:
   - <pre> with overflow-auto
   - Show activeFileContent (find file matching activeFile)
   - Monospace font
   - Gray background

4. copyToClipboard helper:
   - Use navigator.clipboard.writeText
   - Set copied state with ID
   - setTimeout to clear after 2 seconds
```

**FILES_MODIFIED:**
- `components/stack-builder/ExportModal.tsx`

### Prompt 3.5: Build Install Commands Section
```
Add install commands to ExportModal (only if installCommands.length > 0):

1. Section below file viewer, border-t

2. Label: "MCP Install Commands"

3. Dark background (gray-900), green text (terminal style)

4. Map over installCommands:
   - Show command in <code>
   - Copy button for each command
   - "âœ“" feedback on copy

5. Monospace font throughout
```

**FILES_MODIFIED:**
- `components/stack-builder/ExportModal.tsx`

### Prompt 3.6: Build Action Buttons
```
Add action buttons to ExportModal:

1. Footer: border-t, gray background, flex with gap

2. Download ZIP button:
   - Primary blue style
   - Icon: ðŸ“¦
   - handleDownloadZip function:
     - POST to /api/export with format: 'zip'
     - Get blob from response
     - Create object URL
     - Create <a> with href and download attribute
     - Click and revoke URL

3. Copy All button:
   - Secondary/outline style
   - Icon: ðŸ“‹
   - Copies all files concatenated with separators
   - Shows "âœ“ Copied!" feedback
```

**FILES_MODIFIED:**
- `components/stack-builder/ExportModal.tsx`

### Quality Gate 3
```markdown
âœ… Phase 3 Complete when:
- [ ] ExportModal renders without errors
- [ ] File tree shows all generated files
- [ ] Clicking file shows content
- [ ] Copy file content works
- [ ] Copy install command works
- [ ] Download ZIP triggers download
- [ ] Copy All works
- [ ] Dark mode compatible

Report: "âœ… Phase 3 Complete: Export UI ready"
```

---

## Phase 4: Integration (20 prompts, 15 min)

### Prompt 4.1: Add Export Button to Builder
```
Update `app/builder/page.tsx` to add export:

1. Add state:
   - showExport: boolean
   - projectName: string (default 'my-stack')

2. Get canvas components from store/state:
   - Map nodes to component format
   - Include id, type, name, config, prompt, description

3. Add to header (near other buttons):
   - Project name input (text, small width)
   - Export button (green, disabled if no components)

4. Import and render ExportModal:
   <ExportModal
     isOpen={showExport}
     onClose={() => setShowExport(false)}
     components={canvasComponents}
     projectName={projectName}
   />
```

**FILES_MODIFIED:**
- `app/builder/page.tsx`

### Prompt 4.2: Create Install Script Generator (Optional)
```
Create `lib/generate-install-script.ts` for future npx support:

1. Function: generateInstallScript(components, projectName): string

2. Build bash script:
   #!/bin/bash
   # Claude Code Setup Script for {projectName}
   # Generated by Organized AI Stack Builder
   
   echo "ðŸš€ Setting up Claude Code configuration..."
   
   mkdir -p .claude/commands

3. Add MCP install commands if present

4. Add completion message:
   echo "âœ… Setup complete! Start Claude Code in this directory."

5. Export function

6. Add placeholder in ExportModal for future npx command:
   "Quick Setup (coming soon)"
   npx @organized-ai/stack-init {projectName}
```

**FILES_CREATED:**
- `lib/generate-install-script.ts`

### Prompt 4.3: End-to-End Testing
```
Test the complete export flow:

1. Add 3+ components to canvas (mix of types)
2. Click Export button - modal opens
3. Verify file tree shows expected files:
   - .claude/CLAUDE.md
   - .claude/settings.json
   - .claude/commands/*.md (if commands)
   - .claude/mcp.json (if MCPs)
4. Click each file - content displays correctly
5. Copy a file - clipboard has content
6. Download ZIP - opens and contains files
7. Copy All - all content copied
8. Test with empty canvas - button disabled

Fix any issues found.
```

### Quality Gate 4 (Final)
```markdown
âœ… Phase 4 Complete when:
- [ ] Export button visible in builder header
- [ ] Project name editable
- [ ] Button disabled when canvas empty
- [ ] Modal shows correct file structure
- [ ] Downloaded ZIP has all files
- [ ] Files can be used with Claude Code
- [ ] No console errors

Report: "ðŸŽ‰ Export to Claude Code Complete!"
```

---

## Rollback Points

| Phase | Rollback Action |
|-------|-----------------|
| Phase 1 | Delete lib/export-generator.ts |
| Phase 2 | Delete app/api/export/, npm uninstall jszip |
| Phase 3 | Delete ExportModal component |
| Phase 4 | Revert builder/page.tsx |

---

## Commit Message Template

```
feat: Add export to Claude Code functionality

Phase 1: Generator
- Create export generator for CLAUDE.md
- Generate settings.json with hooks
- Generate command files
- Extract MCP configs

Phase 2: API
- Add /api/export endpoint
- Support JSON preview and ZIP download

Phase 3: UI
- Create ExportModal with file preview
- Add copy buttons for files and commands
- Add download ZIP functionality

Phase 4: Integration
- Add Export button to builder header
- Add project name input
- Connect modal to canvas state
```

---

## Files Summary

**Created:**
- `lib/export-generator.ts`
- `lib/generate-install-script.ts`
- `app/api/export/route.ts`
- `components/stack-builder/ExportModal.tsx`

**Modified:**
- `app/builder/page.tsx`
- `package.json` (jszip dependency)
